# Dockerfile pour exécuter les tests MY-IA
FROM python:3.11-slim

WORKDIR /app

# Installer les dépendances système nécessaires
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copier les fichiers de requirements
COPY app/requirements.txt .
COPY requirements-test.txt .

# Installer les dépendances Python
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir -r requirements-test.txt

# Copier le code de l'application
COPY app/ ./app/

# Copier les fichiers de tests
COPY tests/ ./tests/

# Copier la configuration pytest
COPY pytest.ini .

# Copier le script de tests
COPY run_tests.sh .
RUN chmod +x run_tests.sh

# Définir les variables d'environnement pour les tests
ENV PYTHONPATH=/app
ENV LOG_LEVEL=ERROR
ENV API_KEY=test-api-key-12345
ENV OLLAMA_HOST=http://ollama:11434
ENV CHROMA_HOST=http://chroma:8000
ENV MODEL_NAME=mistral:7b
ENV EMBED_MODEL=nomic-embed-text

# Commande par défaut : lancer les tests unitaires
CMD ["pytest", "-m", "unit", "-v", "--tb=short"]
